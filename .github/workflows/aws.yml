name: Deploy Wiz Exercise

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.14.0

jobs:
  deploy:
    name: Deploy Infrastructure and Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./deploy
        run: terraform init

      - name: Terraform Validate
        working-directory: ./deploy
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./deploy
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        id: terraform-apply
        working-directory: ./deploy
        run: terraform apply -auto-approve tfplan
        continue-on-error: true

      - name: Check Terraform Apply Result
        if: steps.terraform-apply.outcome == 'failure'
        working-directory: ./deploy
        run: |
          echo "ERROR: Terraform apply failed"
          echo "Checking for partial infrastructure..."

          terraform show

          echo ""
          echo "Will destroy partial infrastructure in cleanup step..."
          exit 1

      - name: Get MongoDB Private IP
        if: steps.terraform-apply.outcome == 'success'
        id: mongo-ip
        working-directory: ./deploy
        run: |
          MONGO_IP=$(terraform output -raw mongodb_private_ip)
          echo "ip=$MONGO_IP" >> $GITHUB_OUTPUT
          echo "MongoDB Private IP: $MONGO_IP"

      - name: Install kubectl
        if: steps.terraform-apply.outcome == 'success'
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"

      - name: Configure kubectl
        if: steps.terraform-apply.outcome == 'success'
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name wiz-eks
          kubectl version --client
          kubectl cluster-info

      - name: Wait for EKS nodes
        if: steps.terraform-apply.outcome == 'success'
        run: |
          echo "Waiting for nodes to be ready..."
          kubectl wait --for=condition=Ready nodes --all --timeout=600s
          kubectl get nodes

      - name: Update frontend.yaml with MongoDB IP
        if: steps.terraform-apply.outcome == 'success'
        run: |
          sed -i "s/PRIVATE_IP/${{ steps.mongo-ip.outputs.ip }}/g" kubernetes/frontent.yaml
          echo "Updated kubernetes/frontent.yaml:"
          grep "MONGODB_URI" kubernetes/frontent.yaml

      - name: Deploy Application
        if: steps.terraform-apply.outcome == 'success'
        run: |
          kubectl apply -f kubernetes/frontent.yaml
          echo "Application deployed"

      - name: Wait for Deployment
        if: steps.terraform-apply.outcome == 'success'
        run: |
          kubectl rollout status deployment/wizercise --timeout=600s
          echo "Deployment ready"

      - name: Get Deployment Status
        if: steps.terraform-apply.outcome == 'success'
        run: |
          echo "Pods:"
          kubectl get pods -l app=wizercise
          echo ""
          echo "Service:"
          kubectl get svc wizercise-service

      - name: Wait for LoadBalancer URL
        if: steps.terraform-apply.outcome == 'success'
        id: loadbalancer
        run: |
          echo "Waiting for LoadBalancer..."
          for i in {1..30}; do
            LB_URL=$(kubectl get svc wizercise-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
            if [ -n "$LB_URL" ]; then
              echo "url=$LB_URL" >> $GITHUB_OUTPUT
              echo "LoadBalancer ready: $LB_URL"
              break
            fi
            echo "  Waiting... ($i/30)"
            sleep 10
          done

      - name: Display Summary
        if: steps.terraform-apply.outcome == 'success'
        run: |
          echo "======================================================"
          echo "DEPLOYMENT COMPLETE"
          echo "======================================================"
          echo ""
          echo "Deployment Info:"
          echo "  MongoDB Private IP: ${{ steps.mongo-ip.outputs.ip }}"
          echo "  Frontend URL:       http://${{ steps.loadbalancer.outputs.url }}"
          echo ""
          echo "Test the application:"
          echo "  curl http://${{ steps.loadbalancer.outputs.url }}/"
          echo ""
          echo "Useful commands:"
          echo "  kubectl get pods"
          echo "  kubectl logs -l app=wizercise"
          echo "  kubectl get svc wizercise-service"
          echo ""

      - name: Cleanup - Destroy Partial/Failed Infrastructure
        if: failure()
        working-directory: ./deploy
        run: |
          echo "======================================================"
          echo "CLEANUP: Destroying infrastructure after failure"
          echo "======================================================"
          echo ""

          echo "Attempting to clean up Kubernetes resources..."
          kubectl delete -f ../kubernetes/frontent.yaml --ignore-not-found=true 2>/dev/null || true

          echo ""
          echo "Waiting 30 seconds for Kubernetes cleanup..."
          sleep 30

          echo ""
          echo "Running terraform destroy..."
          echo "This will clean up any partially created infrastructure."
          echo ""

          terraform refresh || true

          terraform destroy -auto-approve

          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo ""
            echo "Cleanup successful - all resources destroyed"
          else
            echo ""
            echo "WARNING: Cleanup encountered issues (exit code: $EXIT_CODE)"
            echo "Some resources may need manual cleanup."
            echo ""
            echo "To manually clean up, run:"
            echo "  cd deploy"
            echo "  terraform destroy"
          fi

          echo ""
          echo "======================================================"
